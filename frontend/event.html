<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard CRUD Pariwisata</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        background-color: #f9fafb;
      }
      nav.navbar {
        background-color: #007bff;
      }
      nav.navbar .navbar-brand {
        color: #fff;
        font-weight: bold;
      }
      .container {
        margin-top: 2rem;
      }
      .card {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        border-radius: 12px;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">ðŸŒŠ Pariwisata CRUD</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="navbarNav" class="collapse navbar-collapse">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a
                class="nav-link active"
                href="#"
                onclick="loadTable('destinasi')"
                >Destinasi</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="loadTable('akomodasi')"
                >Akomodasi</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="loadTable('kuliner')"
                >Kuliner</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Kontainer utama -->
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 id="table-title">Data Destinasi</h3>
        <button
          id="btnTambah"
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#modalForm"
        >
          + Tambah Data
        </button>
      </div>

      <!-- Tabel -->
      <div class="card p-3">
        <div class="table-responsive">
          <table class="table table-bordered table-striped" id="dataTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal Form -->
    <div class="modal fade" id="modalForm" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Form Data</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formData">
              <div id="formFields" class="row g-3"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Batal
            </button>
            <button class="btn btn-success" onclick="simpanData()">
              Simpan
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Common CRUD -->
    <script src="common.js"></script>
    <script>
      let currentTable = "destinasi";
      let editId = null;

      async function loadTable(table) {
        currentTable = table;
        document.getElementById("table-title").innerText =
          "Data " + table.charAt(0).toUpperCase() + table.slice(1);

        const data = await listRecords(table);
        const tableEl = document.getElementById("dataTable");
        const thead = tableEl.querySelector("thead");
        const tbody = tableEl.querySelector("tbody");

        tbody.innerHTML = "";
        if (!data.records || data.records.length === 0) {
          thead.innerHTML = "<tr><th>Info</th></tr>";
          tbody.innerHTML = `<tr><td class='text-center text-muted'>Belum ada data</td></tr>`;
          return;
        }

        const keys = Object.keys(data.records[0]);
        thead.innerHTML =
          "<tr>" +
          keys.map((k) => `<th>${k}</th>`).join("") +
          "<th>Aksi</th></tr>";

        tbody.innerHTML = data.records
          .map(
            (row) =>
              `<tr>${keys.map((k) => `<td>${row[k]}</td>`).join("")}
              <td>
                <button class='btn btn-warning btn-sm' onclick='editData(${
                  row.id
                })'>Edit</button>
                <button class='btn btn-danger btn-sm' onclick='hapusData(${
                  row.id
                })'>Hapus</button>
              </td></tr>`
          )
          .join("");
      }

      async function editData(id) {
        editId = id;
        const data = await getRecord(currentTable, id);
        generateForm(Object.keys(data), data);
        new bootstrap.Modal(document.getElementById("modalForm")).show();
      }

      function tambahData() {
        editId = null;
        const contoh = document
          .querySelector("#dataTable tbody tr td")
          ?.innerText.trim();
        if (!contoh) {
          alert("Belum ada data contoh untuk buat form!");
          return;
        }
        generateForm(Object.keys(JSON.parse(JSON.stringify(data.records[0]))));
      }

      function generateForm(fields, data = {}) {
        const container = document.getElementById("formFields");
        container.innerHTML = fields
          .map((f) => {
            if (f === "id") return "";
            return `
          <div class="col-md-6">
            <label class="form-label">${f}</label>
            <input type="text" name="${f}" value="${
              data[f] || ""
            }" class="form-control" />
          </div>`;
          })
          .join("");
      }

      async function simpanData() {
        const form = document.getElementById("formData");
        const formData = Object.fromEntries(new FormData(form).entries());

        if (editId) {
          await updateRecord(currentTable, editId, formData);
        } else {
          await createRecord(currentTable, formData);
        }

        bootstrap.Modal.getInstance(
          document.getElementById("modalForm")
        ).hide();
        loadTable(currentTable);
      }

      async function hapusData(id) {
        if (confirm("Yakin ingin menghapus data ini?")) {
          await deleteRecord(currentTable, id);
          loadTable(currentTable);
        }
      }

      // Load awal
      window.onload = () => loadTable(currentTable);
    </script>
  </body>
</html>
